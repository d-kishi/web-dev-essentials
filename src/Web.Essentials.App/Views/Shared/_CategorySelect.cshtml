@model IEnumerable<Web.Essentials.App.ViewModels.CategorySelectItem>
@using Web.Essentials.App.Extensions
<!-- éšå±¤ã‚«ãƒ†ã‚´ãƒªé¸æŠéƒ¨åˆ†ãƒ“ãƒ¥ãƒ¼ -->
<!-- éšå±¤æ§‹é€ å¯¾å¿œã®ã‚«ãƒ†ã‚´ãƒªé¸æŠUI -->
<!-- å•†å“Create/Editç”»é¢ã§å…±é€šåˆ©ç”¨ -->

@{
    var categories = Model ?? new List<Web.Essentials.App.ViewModels.CategorySelectItem>();
    var selectedCategoryId = ViewBag.SelectedCategoryId as int?;
    var fieldName = ViewBag.FieldName as string ?? "CategoryId";
    var isRequired = ViewBag.IsRequired as bool? ?? true;
    var allowMultiple = ViewBag.AllowMultiple as bool? ?? false;
    var showSearch = ViewBag.ShowSearch as bool? ?? true;
}

<div class="category-select-container">
    <div class="category-select-header">
        <label for="@fieldName" class="form-label @(isRequired ? "required" : "")">
            @(ViewBag.Label ?? "ã‚«ãƒ†ã‚´ãƒª")
        </label>
        @if (showSearch)
        {
            <div class="category-search">
                <input type="text" 
                       id="categorySearchInput" 
                       class="category-search-input" 
                       placeholder="ã‚«ãƒ†ã‚´ãƒªã‚’æ¤œç´¢..."
                       />
                <span class="search-icon">ğŸ”</span>
            </div>
        }
    </div>
    
    <!-- ã‚«ãƒ†ã‚´ãƒªé¸æŠæ–¹å¼åˆ‡ã‚Šæ›¿ãˆ -->
    <div class="category-select-modes">
        <div class="mode-tabs">
            <button type="button" 
                    class="mode-tab active" 
                    data-mode="select">
                é¸æŠãƒªã‚¹ãƒˆ
            </button>
            <button type="button" 
                    class="mode-tab" 
                    data-mode="tree">
                éšå±¤ãƒ„ãƒªãƒ¼
            </button>
            @if (allowMultiple)
            {
                <button type="button" 
                        class="mode-tab" 
                        data-mode="checkbox">
                    è¤‡æ•°é¸æŠ
                </button>
            }
        </div>
    </div>
    
    <!-- é¸æŠãƒªã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ -->
    <div id="selectMode" class="category-mode select-mode active">
        @if (allowMultiple)
        {
            @if (isRequired)
            {
                <select name="@fieldName" 
                        id="@fieldName" 
                        class="form-select category-select"
                        asp-items="@(new SelectList(categories.OrderBy(c => c.Level).ThenBy(c => c.Name).Select(c => new { Value = c.Id, Text = $"{new string('ã€€', c.Level * 2)}{c.Name}", Level = c.Level, FullPath = c.FullPath }), "Value", "Text", selectedCategoryId))"
                        required
                        multiple
                        data-category-select="true">
                </select>
            }
            else
            {
                <select name="@fieldName" 
                        id="@fieldName" 
                        class="form-select category-select"
                        asp-items="@(new SelectList(categories.OrderBy(c => c.Level).ThenBy(c => c.Name).Select(c => new { Value = c.Id, Text = $"{new string('ã€€', c.Level * 2)}{c.Name}", Level = c.Level, FullPath = c.FullPath }), "Value", "Text", selectedCategoryId))"
                        multiple
                        data-category-select="true">
                </select>
            }
        }
        else
        {
            @if (isRequired)
            {
                <select name="@fieldName" 
                        id="@fieldName" 
                        class="form-select category-select"
                        asp-items="@(new SelectList(categories.OrderBy(c => c.Level).ThenBy(c => c.Name).Select(c => new { Value = c.Id, Text = $"{new string('ã€€', c.Level * 2)}{c.Name}", Level = c.Level, FullPath = c.FullPath }), "Value", "Text", selectedCategoryId))"
                        required
                        data-category-select="true">
                    @if (!allowMultiple)
                    {
                        <option value="">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    }
                </select>
            }
            else
            {
                <select name="@fieldName" 
                        id="@fieldName" 
                        class="form-select category-select"
                        asp-items="@(new SelectList(categories.OrderBy(c => c.Level).ThenBy(c => c.Name).Select(c => new { Value = c.Id, Text = $"{new string('ã€€', c.Level * 2)}{c.Name}", Level = c.Level, FullPath = c.FullPath }), "Value", "Text", selectedCategoryId))"
                        data-category-select="true">
                    @if (!allowMultiple)
                    {
                        <option value="">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    }
                </select>
            }
        }
        <div class="selected-category-info" id="selectedCategoryInfo" style="display: none;">
            <div class="info-label">é¸æŠä¸­ã®ã‚«ãƒ†ã‚´ãƒª:</div>
            <div class="info-path" id="selectedCategoryPath"></div>
        </div>
    </div>
    
    <!-- éšå±¤ãƒ„ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ -->
    <div id="treeMode" class="category-mode tree-mode">
        <div class="category-tree-container">
            <div id="categoryTree" class="category-tree">
                @if (categories.Any())
                {
                    <partial name="_CategoryHierarchy" model="categories.Where(c => c.Level == 0)" />
                }
                else
                {
                    <div class="no-categories">
                        <p>ã‚«ãƒ†ã‚´ãƒªãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                    </div>
                }
            </div>
        </div>
        <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆãƒ„ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰ -->
        <input type="hidden" name="@fieldName" id="@(fieldName)_Tree" value="@selectedCategoryId" asp-for="@fieldName" />
    </div>
    
    <!-- è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰ -->
    @if (allowMultiple)
    {
        <div id="checkboxMode" class="category-mode checkbox-mode">
            <div class="category-checkbox-container">
                @foreach (var category in categories.OrderBy(c => c.Level).ThenBy(c => c.Name))
                {
                    <div class="category-checkbox-item level-@category.Level" data-category-id="@category.Id">
                        <label class="checkbox-label" asp-for="@fieldName">
                            <input type="checkbox" 
                                   name="@fieldName" 
                                   value="@category.Id" 
                                   class="checkbox-input category-checkbox"
                                   data-level="@category.Level"
                                   data-full-path="@category.FullPath"
                                   data-category-checkbox="true" />
                            <span class="checkbox-custom"></span>
                            <span class="category-name">
                                @(new string('ã€€', category.Level * 2))@category.Name
                            </span>
                            <span class="category-path">(@category.FullPath)</span>
                        </label>
                    </div>
                }
            </div>
            <div class="selected-categories-summary" id="selectedCategoriesSummary" style="display: none;">
                <div class="summary-label">é¸æŠä¸­ã®ã‚«ãƒ†ã‚´ãƒª:</div>
                <div class="summary-list" id="selectedCategoriesList"></div>
            </div>
        </div>
    }
    
    <!-- ã‚«ãƒ†ã‚´ãƒªéšå±¤æƒ…å ±è¡¨ç¤º -->
    <div class="category-hierarchy-info" id="categoryHierarchyInfo" style="display: none;">
        <div class="hierarchy-label">éšå±¤æƒ…å ±:</div>
        <div class="hierarchy-details">
            <div class="hierarchy-level">
                ãƒ¬ãƒ™ãƒ«: <span id="categoryLevel">-</span>
            </div>
            <div class="hierarchy-path">
                ãƒ‘ã‚¹: <span id="categoryFullPath">-</span>
            </div>
        </div>
    </div>
    
    <!-- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
    <div id="categoryValidationError" class="validation-error" style="display: none;"></div>
    
    <!-- ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆ -->
    <div class="category-help">
        <small>
            @if (allowMultiple)
            {
                <span>è¤‡æ•°ã®ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã§ãã¾ã™ã€‚éšå±¤ã®æ·±ã„ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚</span>
            }
            else
            {
                <span>å•†å“ã«æœ€ã‚‚é©ã—ãŸã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚éšå±¤ã®æ·±ã„ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚</span>
            }
        </small>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/category-select.css" asp-append-version="true" />
}

@section Scripts {
    <script src="~/js/categories/category-select.js" asp-append-version="true" defer></script>
    <script>
        // ã‚«ãƒ†ã‚´ãƒªãƒ‡ãƒ¼ã‚¿ã¨è¨­å®šã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«è¨­å®š
        window.categorySelectData = @Html.Raw(Json.Serialize(categories));
        window.categoryFieldName = '@fieldName';
        window.categoryFieldRequired = @Html.Raw(Json.Serialize(isRequired));
        @if (selectedCategoryId.HasValue)
        {
            <text>window.initialCategorySelection = @selectedCategoryId.Value;</text>
        }
    </script>
}