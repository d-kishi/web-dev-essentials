@model dynamic
@{
    var showActions = ViewBag.ShowActions as bool? ?? true;
    var isSelectable = ViewBag.IsSelectable as bool? ?? false;
    var selectedId = ViewBag.SelectedId as int?;
    var showProductCount = ViewBag.ShowProductCount as bool? ?? true;
    var expandAll = ViewBag.ExpandAll as bool? ?? false;
    
    // dynamicå‹ã§ã¯Any()ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç›´æ¥å‘¼ã³å‡ºã›ãªã„ãŸã‚ã€ã‚«ã‚¦ãƒ³ãƒˆã§ãƒã‚§ãƒƒã‚¯
    var childCategories = Model.ChildCategories as IEnumerable<object>;
    var hasChildren = childCategories != null && childCategories.Count() > 0;
    var isSelected = isSelectable && selectedId == Model.Id;
    var nodeId = $"tree-node-{Model.Id}";
}

<div class="tree-item @(hasChildren ? "expandable" : "") @(expandAll ? "" : "collapsed") @(isSelected ? "selected" : "")" 
     data-category-id="@Model.Id" 
     data-level="@Model.Level"
     id="@nodeId">
    
    <div class="tree-node">
        <!-- å±•é–‹/ç¸®å°ãƒœã‚¿ãƒ³ -->
        @if (hasChildren)
        {
            <button type="button" 
                    class="tree-toggle" 
                    data-node-id="@nodeId"
                    title="@(expandAll ? "ç¸®å°" : "å±•é–‹")">
                @(expandAll ? "â–¼" : "â–¶")
            </button>
        }
        else
        {
            <span class="tree-spacer">ã€€</span>
        }
        
        <!-- ã‚«ãƒ†ã‚´ãƒªã‚¢ã‚¤ã‚³ãƒ³ -->
        <span class="tree-icon">
            @if (Model.Level == 0)
            {
                <span class="icon-root">ğŸ“</span>
            }
            else if (hasChildren)
            {
                <span class="icon-branch">ğŸ“‚</span>
            }
            else
            {
                <span class="icon-leaf">ğŸ·ï¸</span>
            }
        </span>
        
        <!-- ã‚«ãƒ†ã‚´ãƒªå -->
        <div class="tree-content">
            @if (isSelectable)
            {
                <button type="button" 
                        class="category-select-button @(isSelected ? "selected" : "")"
                        data-category-id="@Model.Id"
                        data-category-name="@Model.Name"
                        data-category-path="@Model.FullPath"
                        title="ã“ã®ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ">
                    <span class="category-name">@Model.Name</span>
                </button>
            }
            else
            {
                <div class="tree-label">
                    <span class="category-name">@Model.Name</span>
                </div>
            }
            
            <!-- ã‚«ãƒ†ã‚´ãƒªæƒ…å ± -->
            <div class="tree-meta">
                <!-- éšå±¤ãƒ¬ãƒ™ãƒ« -->
                <span class="level-indicator level-@Model.Level">L@Model.Level</span>
                
                <!-- å•†å“æ•° -->
                @if (showProductCount)
                {
                    <span class="product-count" title="é–¢é€£å•†å“æ•°">
                        ğŸ“¦ @(Model.ProductCount ?? 0)
                    </span>
                }
                
                <!-- å­ã‚«ãƒ†ã‚´ãƒªæ•° -->
                @if (hasChildren)
                {
                    <span class="children-count" title="å­ã‚«ãƒ†ã‚´ãƒªæ•°">
                        ğŸ·ï¸ @(childCategories?.Count() ?? 0)
                    </span>
                }
            </div>
            
            <!-- ã‚«ãƒ†ã‚´ãƒªèª¬æ˜ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ï¼‰ -->
            @if (!string.IsNullOrEmpty(Model.Description))
            {
                <div class="tree-description" id="desc-@Model.Id" style="display: none;">
                    <small>@Model.Description</small>
                </div>
                <button type="button" 
                        class="description-toggle" 
                        data-category-id="@Model.Id"
                        title="èª¬æ˜ã‚’è¡¨ç¤º/éè¡¨ç¤º">
                    ğŸ’¬
                </button>
            }
            
            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            @if (showActions)
            {
                <div class="tree-actions">
                    <a asp-action="Details" asp-controller="Categories" asp-route-id="@Model.Id" 
                       class="tree-action-btn detail-btn" 
                       title="è©³ç´°è¡¨ç¤º">
                        ğŸ‘ï¸
                    </a>
                    <a asp-action="Edit" asp-controller="Categories" asp-route-id="@Model.Id" 
                       class="tree-action-btn edit-btn" 
                       title="ç·¨é›†">
                        âœï¸
                    </a>
                    <a asp-action="Create" asp-controller="Categories" asp-route-parentId="@Model.Id" 
                       class="tree-action-btn add-btn" 
                       title="å­ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ">
                        â•
                    </a>
                    <button type="button" 
                            class="category-delete-button" 
                            data-category-id="@Model.Id"
                            data-category-name="@Model.Name"
                            data-product-count="@(Model.ProductCount ?? 0)"
                            data-has-children="@(hasChildren ? "true" : "false")"
                            title="å‰Šé™¤"
                            disabled="@((Model.ProductCount ?? 0) > 0 || hasChildren)">
                        ğŸ—‘ï¸
                    </button>
                </div>
            }
        </div>
    </div>
    
    <!-- å­ã‚«ãƒ†ã‚´ãƒª -->
    @if (hasChildren)
    {
        <div class="tree-children" style="display: @(expandAll ? "block" : "none");">
            @if (childCategories != null)
            {
                @foreach (var child in childCategories)
                {
                    <partial name="_CategoryTreeNode" model="child" />
                }
            }
        </div>
    }
</div>