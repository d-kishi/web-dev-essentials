@model Web.Essentials.App.ViewModels.CategoryTreeNodeViewModel
@{
    var showActions = ViewBag.ShowActions as bool? ?? true;
    var isSelectable = ViewBag.IsSelectable as bool? ?? false;
    var selectedId = ViewBag.SelectedId as int?;
    var showProductCount = ViewBag.ShowProductCount as bool? ?? true;
    var expandAll = ViewBag.ExpandAll as bool? ?? false;
    
    var hasChildren = Model.ChildCategories.Any();
    var isSelected = isSelectable && selectedId == Model.Id;
    var nodeId = $"tree-node-{Model.Id}";
}

<div class="tree-item @(hasChildren ? "expandable" : "") @(expandAll ? "" : "collapsed") @(isSelected ? "selected" : "")" 
     data-category-id="@Model.Id" 
     data-level="@Model.Level"
     id="@nodeId">
    
    <div class="tree-node">
        <!-- Â±ïÈñã/Á∏ÆÂ∞è„Éú„Çø„É≥ -->
        @if (hasChildren)
        {
            <button type="button" 
                    class="tree-toggle" 
                    data-node-id="@nodeId"
                    title="@(expandAll ? "Á∏ÆÂ∞è" : "Â±ïÈñã")">
                @(expandAll ? "‚ñº" : "‚ñ∂")
            </button>
        }
        else
        {
            <span class="tree-spacer">„ÄÄ</span>
        }
        
        <!-- „Ç´„ÉÜ„Ç¥„É™„Ç¢„Ç§„Ç≥„É≥ -->
        <span class="tree-icon">
            @if (Model.Level == 0)
            {
                <span class="icon-root">üìÅ</span>
            }
            else if (hasChildren)
            {
                <span class="icon-branch">üìÇ</span>
            }
            else
            {
                <span class="icon-leaf">üè∑Ô∏è</span>
            }
        </span>
        
        <!-- „Ç´„ÉÜ„Ç¥„É™Âêç -->
        <div class="tree-content">
            @if (isSelectable)
            {
                <button type="button" 
                        class="category-select-button @(isSelected ? "selected" : "")"
                        data-category-id="@Model.Id"
                        data-category-name="@Model.Name"
                        data-category-path="@Model.FullPath"
                        title="„Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû">
                    <span class="category-name">@Model.Name</span>
                </button>
            }
            else
            {
                <div class="tree-label">
                    <span class="category-name">@Model.Name</span>
                </div>
            }
            
            <!-- „Ç´„ÉÜ„Ç¥„É™ÊÉÖÂ†± -->
            <div class="tree-meta">
                <!-- ÈöéÂ±§„É¨„Éô„É´ -->
                <span class="level-indicator level-@Model.Level">L@Model.Level</span>
                
                <!-- ÂïÜÂìÅÊï∞ -->
                @if (showProductCount)
                {
                    <span class="product-count" title="Èñ¢ÈÄ£ÂïÜÂìÅÊï∞">
                        üì¶ @(Model.ProductCount ?? 0)
                    </span>
                }
                
                <!-- Â≠ê„Ç´„ÉÜ„Ç¥„É™Êï∞ -->
                @if (hasChildren)
                {
                    <span class="children-count" title="Â≠ê„Ç´„ÉÜ„Ç¥„É™Êï∞">
                        üè∑Ô∏è @Model.ChildCategories.Count()
                    </span>
                }
            </div>
            
            <!-- „Ç´„ÉÜ„Ç¥„É™Ë™¨ÊòéÔºàÊäò„Çä„Åü„Åü„ÅøÂèØËÉΩÔºâ -->
            @if (!string.IsNullOrEmpty(Model.Description))
            {
                <div class="tree-description" id="desc-@Model.Id" style="display: none;">
                    <small>@Model.Description</small>
                </div>
                <button type="button" 
                        class="description-toggle" 
                        data-category-id="@Model.Id"
                        title="Ë™¨Êòé„ÇíË°®Á§∫/ÈùûË°®Á§∫">
                    üí¨
                </button>
            }
            
            <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ -->
            @if (showActions)
            {
                <div class="tree-actions">
                    <a asp-action="Details" asp-controller="Categories" asp-route-id="@Model.Id" 
                       class="tree-action-btn detail-btn" 
                       title="Ë©≥Á¥∞Ë°®Á§∫">
                        üëÅÔ∏è
                    </a>
                    <a asp-action="Edit" asp-controller="Categories" asp-route-id="@Model.Id" 
                       class="tree-action-btn edit-btn" 
                       title="Á∑®ÈõÜ">
                        ‚úèÔ∏è
                    </a>
                    <a asp-action="Create" asp-controller="Categories" asp-route-parentId="@Model.Id" 
                       class="tree-action-btn add-btn" 
                       title="Â≠ê„Ç´„ÉÜ„Ç¥„É™„ÇíËøΩÂä†">
                        ‚ûï
                    </a>
                    <button type="button" 
                            class="category-delete-button" 
                            data-category-id="@Model.Id"
                            data-category-name="@Model.Name"
                            data-product-count="@(Model.ProductCount ?? 0)"
                            data-has-children="@(hasChildren ? "true" : "false")"
                            title="ÂâäÈô§"
                            disabled="@((Model.ProductCount ?? 0) > 0 || hasChildren)">
                        üóëÔ∏è
                    </button>
                </div>
            }
        </div>
    </div>
    
    <!-- Â≠ê„Ç´„ÉÜ„Ç¥„É™ -->
    @if (hasChildren)
    {
        <div class="tree-children" style="display: @(expandAll ? "block" : "none");">
            @foreach (var child in Model.ChildCategories)
            {
                <partial name="_CategoryTreeNode" model="child" />
            }
        </div>
    }
</div>