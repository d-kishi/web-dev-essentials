@model Web.Essentials.App.ViewModels.ProductDetailsViewModel
@{
    ViewData["Title"] = $"å•†å“è©³ç´° - {Model.Name}";
}

<!-- å•†å“è©³ç´°ç”»é¢ -->
<div class="page-header">
    <div class="page-title-section">
        <h1 class="page-title">å•†å“è©³ç´°</h1>
        <p class="page-description">å•†å“ã€Œ@Model.Nameã€ã®è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
    </div>
    <div class="page-actions">
        <a href="@Url.Action("Edit", "Product", new { id = Model.Id })" class="btn btn-warning">
            <span class="btn-icon">âœ</span>
            ç·¨é›†
        </a>
        <button type="button" 
                class="btn btn-danger" 
                onclick="confirmDeleteProduct(@Model.Id, '@Model.Name')">
            <span class="btn-icon">ğŸ—‘</span>
            å‰Šé™¤
        </button>
        <a href="@Url.Action("Index", "Product")" class="btn btn-secondary">
            <span class="btn-icon">â†</span>
            å•†å“ä¸€è¦§ã«æˆ»ã‚‹
        </a>
    </div>
</div>

<!-- ãƒ‘ãƒ³ããšãƒŠãƒ“ -->
<nav class="breadcrumb-nav" aria-label="ãƒ‘ãƒ³ããšãƒŠãƒ“">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="@Url.Action("Index", "Home")">ãƒ›ãƒ¼ãƒ </a>
        </li>
        <li class="breadcrumb-item">
            <a href="@Url.Action("Index", "Product")">å•†å“ä¸€è¦§</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            @Model.Name
        </li>
    </ol>
</nav>

<!-- å•†å“è©³ç´°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
<div class="product-details-container">
    <div class="product-overview">
        <!-- å•†å“ç”»åƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="product-images">
            @if (Model.Images?.Any() == true)
            {
                <div class="image-gallery">
                    <!-- ãƒ¡ã‚¤ãƒ³ç”»åƒ -->
                    <div class="main-image-container">
                        @{
                            var mainImage = Model.Images.FirstOrDefault(img => img.IsMain) ?? Model.Images.First();
                        }
                        <img id="mainProductImage" 
                             src="@mainImage.ImagePath" 
                             alt="@mainImage.AltText" 
                             class="main-product-image" />
                        <div class="image-zoom-overlay" onclick="openImageModal('@mainImage.ImagePath', '@mainImage.AltText')">
                            <span class="zoom-icon">ğŸ”</span>
                        </div>
                    </div>
                    
                    <!-- ç”»åƒã‚µãƒ ãƒã‚¤ãƒ« -->
                    @if (Model.Images.Count > 1)
                    {
                        <div class="image-thumbnails">
                            @foreach (var image in Model.Images.OrderBy(img => img.DisplayOrder))
                            {
                                <div class="thumbnail-item @(image.IsMain ? "active" : "")"
                                     onclick="changeMainImage('@image.ImagePath', '@image.AltText', this)">
                                    <img src="@image.ImagePath" 
                                         alt="@image.AltText" 
                                         class="thumbnail-image" />
                                </div>
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="no-image-container">
                    <img src="/images/no-image.png" alt="ç”»åƒãªã—" class="no-image" />
                    <p class="no-image-text">ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            }
        </div>
        
        <!-- å•†å“åŸºæœ¬æƒ…å ± -->
        <div class="product-basic-info">
            <div class="product-header">
                <h2 class="product-name">@Model.Name</h2>
                <div class="product-status">
                    @switch (Model.Status)
                    {
                        case 0:
                            <span class="status-badge status-pending">è²©å£²é–‹å§‹å‰</span>
                            break;
                        case 1:
                            <span class="status-badge status-active">è²©å£²ä¸­</span>
                            break;
                        case 2:
                            <span class="status-badge status-discontinued">å–æ‰±çµ‚äº†</span>
                            break;
                    }
                </div>
            </div>
            
            <div class="product-price">
                <span class="price-label">ä¾¡æ ¼</span>
                <span class="price-value">Â¥@Model.Price.ToString("N0")</span>
                <span class="price-tax">(ç¨è¾¼)</span>
            </div>
            
            @if (!string.IsNullOrEmpty(Model.Description))
            {
                <div class="product-description">
                    <h3 class="description-title">å•†å“èª¬æ˜</h3>
                    <div class="description-content">
                        @Html.Raw(Model.Description.Replace("\n", "<br />"))
                    </div>
                </div>
            }
            
            <!-- ã‚«ãƒ†ã‚´ãƒªæƒ…å ± -->
            @if (Model.Categories?.Any() == true)
            {
                <div class="product-categories">
                    <h3 class="categories-title">ã‚«ãƒ†ã‚´ãƒª</h3>
                    <div class="categories-list">
                        @foreach (var category in Model.Categories)
                        {
                            <div class="category-item">
                                <a href="@Url.Action("Details", "Categories", new { id = category.Id })" 
                                   class="category-link">
                                    @category.FullPath
                                </a>
                            </div>
                        }
                    </div>
                </div>
            }
            
            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            <div class="product-actions">
                <div class="action-buttons">
                    <a href="@Url.Action("Edit", "Product", new { id = Model.Id })" 
                       class="btn btn-primary btn-large">
                        <span class="btn-icon">âœ</span>
                        ã“ã®å•†å“ã‚’ç·¨é›†
                    </a>
                    <button type="button" 
                            class="btn btn-outline btn-large" 
                            onclick="duplicateProduct(@Model.Id)">
                        <span class="btn-icon">ğŸ“‹</span>
                        è¤‡è£½ã—ã¦æ–°è¦ä½œæˆ
                    </button>
                    <button type="button" 
                            class="btn btn-light btn-large" 
                            onclick="shareProduct()">
                        <span class="btn-icon">ğŸ“¤</span>
                        å…±æœ‰
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å•†å“è©³ç´°æƒ…å ± -->
    <div class="product-details-info">
        <div class="details-tabs">
            <div class="tab-navigation">
                <button class="tab-button active" onclick="showTab('specifications')" data-tab="specifications">
                    å•†å“ä»•æ§˜
                </button>
                <button class="tab-button" onclick="showTab('metadata')" data-tab="metadata">
                    ç®¡ç†æƒ…å ±
                </button>
                <button class="tab-button" onclick="showTab('history')" data-tab="history">
                    å¤‰æ›´å±¥æ­´
                </button>
            </div>
            
            <!-- å•†å“ä»•æ§˜ã‚¿ãƒ– -->
            <div id="specificationsTab" class="tab-content active">
                <div class="specifications-grid">
                    <div class="spec-item">
                        <label class="spec-label">å•†å“ID</label>
                        <span class="spec-value">@Model.Id</span>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(Model.JanCode))
                    {
                        <div class="spec-item">
                            <label class="spec-label">JANã‚³ãƒ¼ãƒ‰</label>
                            <span class="spec-value">
                                <code class="jan-code">@Model.JanCode</code>
                                <button type="button" 
                                        class="copy-button" 
                                        onclick="copyToClipboard('@Model.JanCode')"
                                        title="ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼">
                                    ğŸ“‹
                                </button>
                            </span>
                        </div>
                    }
                    
                    <div class="spec-item">
                        <label class="spec-label">å•†å“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                        <span class="spec-value">
                            @switch (Model.Status)
                            {
                                case 0:
                                    <span class="status-text">è²©å£²é–‹å§‹å‰</span>
                                    break;
                                case 1:
                                    <span class="status-text">è²©å£²ä¸­</span>
                                    break;
                                case 2:
                                    <span class="status-text">å–æ‰±çµ‚äº†</span>
                                    break;
                            }
                        </span>
                    </div>
                    
                    @if (Model.Images?.Any() == true)
                    {
                        <div class="spec-item">
                            <label class="spec-label">ç”»åƒæ•°</label>
                            <span class="spec-value">@Model.Images.Count æš</span>
                        </div>
                    }
                </div>
            </div>
            
            <!-- ç®¡ç†æƒ…å ±ã‚¿ãƒ– -->
            <div id="metadataTab" class="tab-content">
                <div class="metadata-grid">
                    <div class="metadata-item">
                        <label class="metadata-label">ä½œæˆæ—¥æ™‚</label>
                        <span class="metadata-value">
                            <time datetime="@Model.CreatedAt.ToString("yyyy-MM-ddTHH:mm:ss")">
                                @Model.CreatedAt.ToString("yyyyå¹´MMæœˆddæ—¥ HH:mm:ss")
                            </time>
                        </span>
                    </div>
                    
                    <div class="metadata-item">
                        <label class="metadata-label">æœ€çµ‚æ›´æ–°æ—¥æ™‚</label>
                        <span class="metadata-value">
                            <time datetime="@Model.UpdatedAt.ToString("yyyy-MM-ddTHH:mm:ss")">
                                @Model.UpdatedAt.ToString("yyyyå¹´MMæœˆddæ—¥ HH:mm:ss")
                            </time>
                        </span>
                    </div>
                    
                    @if (Model.CreatedAt != Model.UpdatedAt)
                    {
                        <div class="metadata-item">
                            <label class="metadata-label">æœ€çµ‚æ›´æ–°ã‹ã‚‰ã®çµŒéæ™‚é–“</label>
                            <span class="metadata-value">
                                @{
                                    var timeDiff = DateTime.Now - Model.UpdatedAt;
                                    var timeDiffText = timeDiff.Days > 0 ? $"{timeDiff.Days}æ—¥å‰" :
                                                      timeDiff.Hours > 0 ? $"{timeDiff.Hours}æ™‚é–“å‰" :
                                                      timeDiff.Minutes > 0 ? $"{timeDiff.Minutes}åˆ†å‰" : "1åˆ†ä»¥å†…";
                                }
                                @timeDiffText
                            </span>
                        </div>
                    }
                </div>
            </div>
            
            <!-- å¤‰æ›´å±¥æ­´ã‚¿ãƒ– -->
            <div id="historyTab" class="tab-content">
                <div class="history-container">
                    <div id="changeHistoryContent" class="history-content">
                        <p class="loading-text">å¤‰æ›´å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç”»åƒæ‹¡å¤§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="imageModal" class="modal-overlay image-modal" style="display: none;" onclick="closeImageModal()">
    <div class="modal-dialog modal-large">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="imageModalTitle">å•†å“ç”»åƒ</h3>
                <button type="button" class="modal-close" onclick="closeImageModal()">
                    <span>Ã—</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="image-modal-container">
                    <img id="modalImage" src="" alt="" class="modal-image" />
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeProductDetails();
        });
        
        // å•†å“è©³ç´°ã®åˆæœŸåŒ–
        function initializeProductDetails() {
            // ã‚¿ãƒ–æ©Ÿèƒ½ã®åˆæœŸåŒ–
            setupTabs();
            
            // å¤‰æ›´å±¥æ­´ã®èª­ã¿è¾¼ã¿
            loadChangeHistory();
            
            // ç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼ã®åˆæœŸåŒ–
            setupImageGallery();
        }
        
        // ã‚¿ãƒ–è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // å¤‰æ›´å±¥æ­´ã‚¿ãƒ–ã®å ´åˆã¯å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
            if (tabName === 'history') {
                loadChangeHistory();
            }
        }
        
        // ãƒ¡ã‚¤ãƒ³ç”»åƒå¤‰æ›´
        function changeMainImage(imagePath, altText, thumbnailElement) {
            const mainImage = document.getElementById('mainProductImage');
            mainImage.src = imagePath;
            mainImage.alt = altText;
            
            // ã‚µãƒ ãƒã‚¤ãƒ«ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.thumbnail-item').forEach(item => item.classList.remove('active'));
            thumbnailElement.classList.add('active');
        }
        
        // ç”»åƒæ‹¡å¤§ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function openImageModal(imagePath, altText) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('imageModalTitle');
            
            modalImage.src = imagePath;
            modalImage.alt = altText;
            modalTitle.textContent = altText || 'å•†å“ç”»åƒ';
            
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        // ç”»åƒæ‹¡å¤§ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        // å•†å“å‰Šé™¤ç¢ºèª
        function confirmDeleteProduct(productId, productName) {
            showConfirmationModal(
                'å•†å“å‰Šé™¤ã®ç¢ºèª',
                `å•†å“ã€Œ${productName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`,
                'å‰Šé™¤ã™ã‚‹ã¨å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚é–¢é€£ã™ã‚‹ç”»åƒã‚„æƒ…å ±ã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚',
                'å‰Šé™¤',
                () => deleteProduct(productId)
            );
        }
        
        // å•†å“å‰Šé™¤å®Ÿè¡Œ
        async function deleteProduct(productId) {
            try {
                showLoadingModal('å•†å“ã‚’å‰Šé™¤ã—ã¦ã„ã¾ã™...');
                
                const response = await fetch(`/Product/Delete/${productId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getAntiForgeryToken()
                    }
                });
                
                hideLoadingModal();
                
                if (response.ok) {
                    showSuccess('å•†å“ãŒæ­£å¸¸ã«å‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
                    
                    // å•†å“ä¸€è¦§ã«æˆ»ã‚‹
                    setTimeout(() => {
                        window.location.href = '/Product';
                    }, 1500);
                } else {
                    const errorText = await response.text();
                    showError('å•†å“ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + errorText);
                }
            } catch (error) {
                hideLoadingModal();
                console.error('å•†å“å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                showError('å•†å“å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
        
        // å•†å“è¤‡è£½
        async function duplicateProduct(productId) {
            try {
                showLoadingModal('å•†å“ã‚’è¤‡è£½ã—ã¦ã„ã¾ã™...');
                
                const response = await fetch(`/Product/Duplicate/${productId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getAntiForgeryToken()
                    }
                });
                
                hideLoadingModal();
                
                if (response.ok) {
                    const result = await response.json();
                    showSuccess('å•†å“ãŒè¤‡è£½ã•ã‚Œã¾ã—ãŸ');
                    
                    // è¤‡è£½ã•ã‚ŒãŸå•†å“ã®ç·¨é›†ç”»é¢ã«ç§»å‹•
                    setTimeout(() => {
                        window.location.href = `/Product/Edit/${result.newProductId}`;
                    }, 1500);
                } else {
                    const errorText = await response.text();
                    showError('å•†å“ã®è¤‡è£½ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + errorText);
                }
            } catch (error) {
                hideLoadingModal();
                console.error('å•†å“è¤‡è£½ã‚¨ãƒ©ãƒ¼:', error);
                showError('å•†å“è¤‡è£½ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
        
        // å•†å“å…±æœ‰
        function shareProduct() {
            const url = window.location.href;
            const productName = '@Model.Name';
            const shareText = `å•†å“ã€Œ${productName}ã€ã®è©³ç´°ã‚’ã”è¦§ãã ã•ã„`;
            
            if (navigator.share) {
                // ãƒã‚¤ãƒ†ã‚£ãƒ–å…±æœ‰APIä½¿ç”¨
                navigator.share({
                    title: productName,
                    text: shareText,
                    url: url
                });
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                copyToClipboard(url);
                showSuccess('å•†å“URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }
        }
        
        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showSuccess('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                showSuccess('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }
        }
        
        // å¤‰æ›´å±¥æ­´èª­ã¿è¾¼ã¿
        async function loadChangeHistory() {
            try {
                const historyContent = document.getElementById('changeHistoryContent');
                historyContent.innerHTML = '<p class="loading-text">å¤‰æ›´å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
                
                const response = await fetch(`/Product/GetChangeHistory/@Model.Id`);
                
                if (response.ok) {
                    const history = await response.json();
                    renderChangeHistory(history);
                } else {
                    historyContent.innerHTML = '<p class="error-text">å¤‰æ›´å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
                }
            } catch (error) {
                console.error('å¤‰æ›´å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('changeHistoryContent').innerHTML = 
                    '<p class="error-text">å¤‰æ›´å±¥æ­´ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
            }
        }
        
        // å¤‰æ›´å±¥æ­´è¡¨ç¤º
        function renderChangeHistory(history) {
            const historyContent = document.getElementById('changeHistoryContent');
            
            if (!history || history.length === 0) {
                historyContent.innerHTML = '<p class="no-data-text">å¤‰æ›´å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            const historyHtml = history.map(item => `
                <div class="history-item">
                    <div class="history-header">
                        <span class="history-date">${new Date(item.changedAt).toLocaleString()}</span>
                        <span class="history-type">${item.changeType}</span>
                    </div>
                    <div class="history-details">
                        ${item.changes.map(change => `
                            <div class="history-change">
                                <span class="change-field">${change.fieldName}</span>
                                <span class="change-from">${change.oldValue || '(ç©º)'}</span>
                                <span class="change-arrow">â†’</span>
                                <span class="change-to">${change.newValue || '(ç©º)'}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            
            historyContent.innerHTML = historyHtml;
        }
        
        // ESCã‚­ãƒ¼ã§ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeImageModal();
            }
        });
    </script>
}