@model Web.Essentials.App.ViewModels.ProductCreateViewModel
@{
    ViewData["Title"] = "å•†å“ç™»éŒ²";
}

<!-- å•†å“ç™»éŒ²ç”»é¢ -->
<div class="page-header">
    <div class="page-title-section">
        <h1 class="page-title">å•†å“ç™»éŒ²</h1>
        <p class="page-description">æ–°ã—ã„å•†å“ã‚’ç™»éŒ²ã—ã¾ã™ã€‚å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
    </div>
    <div class="page-actions">
        <a href="@Url.Action("Index", "Product")" class="btn btn-secondary">
            <span class="btn-icon">â†</span>
            å•†å“ä¸€è¦§ã«æˆ»ã‚‹
        </a>
    </div>
</div>

<!-- ãƒ‘ãƒ³ããšãƒŠãƒ“ -->
<nav class="breadcrumb-nav" aria-label="ãƒ‘ãƒ³ããšãƒŠãƒ“">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="@Url.Action("Index", "Home")">ãƒ›ãƒ¼ãƒ </a>
        </li>
        <li class="breadcrumb-item">
            <a href="@Url.Action("Index", "Product")">å•†å“ä¸€è¦§</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            å•†å“ç™»éŒ²
        </li>
    </ol>
</nav>

<!-- å•†å“ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
<div class="form-container">
    <form asp-action="Create" 
          method="post" 
          enctype="multipart/form-data" 
          id="productCreateForm" 
          class="product-form"
          novalidate>
        
        @Html.AntiForgeryToken()
        
        <!-- å•†å“ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆéƒ¨åˆ†ãƒ“ãƒ¥ãƒ¼ï¼‰ -->
        @Html.Partial("_ProductForm", Model)
        
        <!-- ãƒ•ã‚©ãƒ¼ãƒ æ“ä½œãƒœã‚¿ãƒ³ -->
        <div class="form-actions">
            <div class="action-buttons">
                <button type="submit" class="btn btn-primary btn-large" id="saveButton">
                    <span class="btn-icon">ğŸ’¾</span>
                    å•†å“ã‚’ç™»éŒ²
                </button>
                <button type="button" class="btn btn-secondary btn-large" onclick="showSaveAsDraftModal()">
                    <span class="btn-icon">ğŸ“‹</span>
                    ä¸‹æ›¸ãä¿å­˜
                </button>
                <button type="button" class="btn btn-outline btn-large" onclick="previewProduct()">
                    <span class="btn-icon">ğŸ‘</span>
                    ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                </button>
                <button type="button" class="btn btn-light btn-large" onclick="resetForm()">
                    <span class="btn-icon">â†»</span>
                    ãƒªã‚»ãƒƒãƒˆ
                </button>
            </div>
            
            <!-- ä¿å­˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
            <div class="save-options">
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="saveAndContinue" class="checkbox-input">
                        <span class="checkbox-custom"></span>
                        ä¿å­˜å¾Œã€ç¶šã‘ã¦æ–°ã—ã„å•†å“ã‚’ç™»éŒ²ã™ã‚‹
                    </label>
                </div>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="validateBeforeSave" class="checkbox-input" checked>
                        <span class="checkbox-custom"></span>
                        ä¿å­˜å‰ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹
                    </label>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="productPreviewModal" class="modal-overlay preview-modal" style="display: none;">
    <div class="modal-dialog modal-large">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">å•†å“ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <button type="button" class="modal-close" onclick="closePreviewModal()">
                    <span>Ã—</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="productPreviewContent" class="preview-content">
                    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closePreviewModal()">
                    é–‰ã˜ã‚‹
                </button>
                <button type="button" class="btn btn-primary" onclick="submitFromPreview()">
                    ã“ã®ã¾ã¾ç™»éŒ²ã™ã‚‹
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ä¸‹æ›¸ãä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="saveAsDraftModal" class="modal-overlay" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ä¸‹æ›¸ãä¿å­˜</h3>
                <button type="button" class="modal-close" onclick="closeSaveAsDraftModal()">
                    <span>Ã—</span>
                </button>
            </div>
            <div class="modal-body">
                <p>å…¥åŠ›ä¸­ã®å•†å“æƒ…å ±ã‚’ä¸‹æ›¸ãã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ</p>
                <div class="form-group">
                    <label for="draftName" class="form-label">ä¸‹æ›¸ãå</label>
                    <input type="text" 
                           id="draftName" 
                           class="form-input" 
                           placeholder="ä¸‹æ›¸ãã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
                           maxlength="50" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeSaveAsDraftModal()">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="button" class="btn btn-primary" onclick="saveAsDraft()">
                    ä¸‹æ›¸ãä¿å­˜
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeProductCreateForm();
        });
        
        // å•†å“ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®åˆæœŸåŒ–
        function initializeProductCreateForm() {
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®š
            setupFormValidation();
            
            // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®è¨­å®š
            setupImageUpload();
            
            // ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ã®è¨­å®š
            setupAutoSave();
            
            // ãƒ•ã‚©ãƒ¼ãƒ å¤‰æ›´æ¤œçŸ¥ã®è¨­å®š
            setupFormChangeDetection();
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        document.getElementById('productCreateForm').addEventListener('submit', function(event) {
            const validateBeforeSave = document.getElementById('validateBeforeSave').checked;
            
            if (validateBeforeSave) {
                event.preventDefault();
                
                if (validateProductForm()) {
                    submitProductForm();
                }
            }
        });
        
        // å•†å“ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function validateProductForm() {
            let isValid = true;
            const errors = [];
            
            // å•†å“åã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const nameInput = document.querySelector('input[name="Name"]');
            if (!nameInput.value.trim()) {
                errors.push('å•†å“åã¯å¿…é ˆã§ã™');
                highlightFieldError(nameInput);
                isValid = false;
            }
            
            // ä¾¡æ ¼ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const priceInput = document.querySelector('input[name="Price"]');
            const price = parseInt(priceInput.value);
            if (isNaN(price) || price < 0) {
                errors.push('ä¾¡æ ¼ã¯0ä»¥ä¸Šã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                highlightFieldError(priceInput);
                isValid = false;
            }
            
            // ã‚«ãƒ†ã‚´ãƒªã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const categorySelect = document.querySelector('select[name="CategoryId"]');
            if (!categorySelect.value) {
                errors.push('ã‚«ãƒ†ã‚´ãƒªã¯å¿…é ˆã§ã™');
                highlightFieldError(categorySelect);
                isValid = false;
            }
            
            // JANã‚³ãƒ¼ãƒ‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
            const janCodeInput = document.querySelector('input[name="JanCode"]');
            if (janCodeInput.value && !/^[0-9]{8,13}$/.test(janCodeInput.value)) {
                errors.push('JANã‚³ãƒ¼ãƒ‰ã¯8ã€œ13æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                highlightFieldError(janCodeInput);
                isValid = false;
            }
            
            // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
            if (!isValid) {
                showValidationErrors(errors);
            } else {
                hideValidationErrors();
            }
            
            return isValid;
        }
        
        // å•†å“ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        async function submitProductForm() {
            try {
                showLoadingModal('å•†å“ã‚’ç™»éŒ²ã—ã¦ã„ã¾ã™...');
                
                const formData = new FormData(document.getElementById('productCreateForm'));
                
                const response = await fetch('/Product/Create', {
                    method: 'POST',
                    body: formData
                });
                
                hideLoadingModal();
                
                if (response.ok) {
                    const saveAndContinue = document.getElementById('saveAndContinue').checked;
                    
                    showSuccess('å•†å“ãŒæ­£å¸¸ã«ç™»éŒ²ã•ã‚Œã¾ã—ãŸ');
                    
                    if (saveAndContinue) {
                        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ç¶šè¡Œ
                        resetForm();
                    } else {
                        // å•†å“ä¸€è¦§ã«æˆ»ã‚‹
                        setTimeout(() => {
                            window.location.href = '/Product';
                        }, 1500);
                    }
                } else {
                    const errorText = await response.text();
                    showError('å•†å“ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + errorText);
                }
            } catch (error) {
                hideLoadingModal();
                console.error('å•†å“ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
                showError('å•†å“ç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        function previewProduct() {
            const formData = collectFormData();
            const previewContent = generatePreviewContent(formData);
            
            document.getElementById('productPreviewContent').innerHTML = previewContent;
            document.getElementById('productPreviewModal').style.display = 'block';
        }
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ç™»éŒ²
        function submitFromPreview() {
            closePreviewModal();
            
            if (validateProductForm()) {
                submitProductForm();
            }
        }
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closePreviewModal() {
            document.getElementById('productPreviewModal').style.display = 'none';
        }
        
        // ä¸‹æ›¸ãä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showSaveAsDraftModal() {
            const productName = document.querySelector('input[name="Name"]').value;
            const draftName = productName ? `${productName}_ä¸‹æ›¸ã_${new Date().toLocaleDateString()}` : `å•†å“ä¸‹æ›¸ã_${new Date().toLocaleDateString()}`;
            
            document.getElementById('draftName').value = draftName;
            document.getElementById('saveAsDraftModal').style.display = 'block';
        }
        
        // ä¸‹æ›¸ãä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeSaveAsDraftModal() {
            document.getElementById('saveAsDraftModal').style.display = 'none';
        }
        
        // ä¸‹æ›¸ãä¿å­˜å®Ÿè¡Œ
        function saveAsDraft() {
            const draftName = document.getElementById('draftName').value;
            const formData = collectFormData();
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            const draftData = {
                name: draftName,
                data: formData,
                savedAt: new Date().toISOString()
            };
            
            localStorage.setItem(`product_draft_${Date.now()}`, JSON.stringify(draftData));
            
            showSuccess(`ä¸‹æ›¸ãã€Œ${draftName}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
            closeSaveAsDraftModal();
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        function resetForm() {
            if (confirm('å…¥åŠ›å†…å®¹ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                document.getElementById('productCreateForm').reset();
                clearImagePreviews();
                hideValidationErrors();
            }
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿åé›†
        function collectFormData() {
            const form = document.getElementById('productCreateForm');
            const formData = new FormData(form);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            return data;
        }
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ
        function generatePreviewContent(data) {
            return `
                <div class="product-preview">
                    <div class="preview-header">
                        <h2>${data.Name || 'å•†å“åæœªå…¥åŠ›'}</h2>
                        <div class="preview-price">Â¥${parseInt(data.Price || 0).toLocaleString()}</div>
                    </div>
                    <div class="preview-body">
                        <div class="preview-section">
                            <h3>å•†å“èª¬æ˜</h3>
                            <p>${data.Description || 'èª¬æ˜ãªã—'}</p>
                        </div>
                        <div class="preview-section">
                            <h3>å•†å“æƒ…å ±</h3>
                            <dl class="preview-details">
                                <dt>ã‚«ãƒ†ã‚´ãƒª</dt>
                                <dd>${getCategoryName(data.CategoryId) || 'æœªé¸æŠ'}</dd>
                                <dt>JANã‚³ãƒ¼ãƒ‰</dt>
                                <dd>${data.JanCode || 'ãªã—'}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ã‚«ãƒ†ã‚´ãƒªåå–å¾—
        function getCategoryName(categoryId) {
            const categorySelect = document.querySelector('select[name="CategoryId"]');
            const option = categorySelect.querySelector(`option[value="${categoryId}"]`);
            return option ? option.textContent : null;
        }
    </script>
}