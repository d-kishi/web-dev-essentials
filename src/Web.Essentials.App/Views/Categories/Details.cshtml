@model Web.Essentials.App.ViewModels.CategoryDetailsViewModel
@{
    ViewData["Title"] = $"ã‚«ãƒ†ã‚´ãƒªè©³ç´° - {Model.Name}";
}

<!-- ã‚«ãƒ†ã‚´ãƒªè©³ç´°ç”»é¢ -->
<div class="page-header">
    <div class="page-title-section">
        <h1 class="page-title">ã‚«ãƒ†ã‚´ãƒªè©³ç´°</h1>
        <p class="page-description">ã‚«ãƒ†ã‚´ãƒªã€Œ@Model.Nameã€ã®è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
    </div>
    <div class="page-actions">
        <a asp-action="Edit" asp-controller="Categories" asp-route-id="@Model.Id" class="btn btn-warning">
            <span class="btn-icon">âœ</span>
            ç·¨é›†
        </a>
        <button type="button" 
                class="btn btn-danger" 
                onclick="confirmDeleteCategory(@Model.Id, '@Model.Name', @Model.ProductCount, @(Model.ChildCategories?.Any() == true ? "true" : "false"))"
                @(Model.ProductCount > 0 || Model.ChildCategories?.Any() == true ? "disabled title='é–¢é€£å•†å“ã¾ãŸã¯å­ã‚«ãƒ†ã‚´ãƒªãŒå­˜åœ¨ã™ã‚‹ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“'" : "")>
            <span class="btn-icon">ğŸ—‘</span>
            å‰Šé™¤
        </button>
        <a asp-action="Index" asp-controller="Categories" class="btn btn-secondary">
            <span class="btn-icon">â†</span>
            ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã«æˆ»ã‚‹
        </a>
    </div>
</div>

<!-- ãƒ‘ãƒ³ããšãƒŠãƒ“ -->
<nav class="breadcrumb-nav" aria-label="ãƒ‘ãƒ³ããšãƒŠãƒ“">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a asp-action="Index" asp-controller="Home">ãƒ›ãƒ¼ãƒ </a>
        </li>
        <li class="breadcrumb-item">
            <a asp-action="Index" asp-controller="Categories">ã‚«ãƒ†ã‚´ãƒªä¸€è¦§</a>
        </li>
        @if (!string.IsNullOrEmpty(Model.FullPath))
        {
            var pathParts = Model.FullPath.Split(" > ");
            for (int i = 0; i < pathParts.Length - 1; i++)
            {
                <li class="breadcrumb-item">
                    <span>@pathParts[i]</span>
                </li>
            }
        }
        <li class="breadcrumb-item active" aria-current="page">
            @Model.Name
        </li>
    </ol>
</nav>

<!-- ã‚«ãƒ†ã‚´ãƒªè©³ç´°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
<div class="category-details-container">
    <div class="category-overview">
        <!-- ã‚«ãƒ†ã‚´ãƒªåŸºæœ¬æƒ…å ± -->
        <div class="category-basic-info">
            <div class="category-header">
                <h2 class="category-name">@Model.Name</h2>
                <div class="category-level">
                    <span class="level-badge level-@Model.Level">ãƒ¬ãƒ™ãƒ« @Model.Level</span>
                    @if (Model.Level == 0)
                    {
                        <span class="level-description">ï¼ˆãƒ«ãƒ¼ãƒˆã‚«ãƒ†ã‚´ãƒªï¼‰</span>
                    }
                    else
                    {
                        <span class="level-description">ï¼ˆ@Model.Level éšå±¤ç›®ï¼‰</span>
                    }
                </div>
            </div>
            
            @if (!string.IsNullOrEmpty(Model.Description))
            {
                <div class="category-description">
                    <h3 class="description-title">ã‚«ãƒ†ã‚´ãƒªèª¬æ˜</h3>
                    <div class="description-content">
                        @Html.Raw(Model.Description.Replace("\n", "<br />"))
                    </div>
                </div>
            }
            
            <!-- éšå±¤ãƒ‘ã‚¹ -->
            @if (!string.IsNullOrEmpty(Model.FullPath))
            {
                <div class="category-path">
                    <h3 class="path-title">éšå±¤ãƒ‘ã‚¹</h3>
                    <div class="path-content">
                        <nav class="category-path-nav">
                            @{
                                var pathParts = Model.FullPath.Split(" > ");
                                for (int i = 0; i < pathParts.Length; i++)
                                {
                                    if (i > 0)
                                    {
                                        <span class="path-separator">â–¶</span>
                                    }
                                    if (i == pathParts.Length - 1)
                                    {
                                        <span class="path-current">@pathParts[i]</span>
                                    }
                                    else
                                    {
                                        <span class="path-ancestor">@pathParts[i]</span>
                                    }
                                }
                            }
                        </nav>
                    </div>
                </div>
            }
            
            <!-- çµ±è¨ˆæƒ…å ± -->
            <div class="category-statistics">
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-icon">ğŸ“¦</span>
                        <div class="stat-content">
                            <div class="stat-value">@Model.ProductCount</div>
                            <div class="stat-label">ç™»éŒ²å•†å“æ•°</div>
                        </div>
                    </div>
                    
                    @if (Model.ChildCategories?.Any() == true)
                    {
                        <div class="stat-item">
                            <span class="stat-icon">ğŸ·ï¸</span>
                            <div class="stat-content">
                                <div class="stat-value">@Model.ChildCategories.Count()</div>
                                <div class="stat-label">å­ã‚«ãƒ†ã‚´ãƒªæ•°</div>
                            </div>
                        </div>
                    }
                    
                    <div class="stat-item">
                        <span class="stat-icon">ğŸ“…</span>
                        <div class="stat-content">
                            <div class="stat-value">
                                @{
                                    var daysSinceCreated = (DateTime.Now - Model.CreatedAt).Days;
                                }
                                @daysSinceCreated æ—¥
                            </div>
                            <div class="stat-label">ä½œæˆã‹ã‚‰ã®æ—¥æ•°</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            <div class="category-actions">
                <div class="action-buttons">
                    <a asp-action="Edit" asp-controller="Categories" asp-route-id="@Model.Id" 
                       class="btn btn-primary btn-large">
                        <span class="btn-icon">âœ</span>
                        ã“ã®ã‚«ãƒ†ã‚´ãƒªã‚’ç·¨é›†
                    </a>
                    <a asp-action="Create" asp-controller="Categories" asp-route-parentId="@Model.Id" 
                       class="btn btn-outline btn-large">
                        <span class="btn-icon">â•</span>
                        å­ã‚«ãƒ†ã‚´ãƒªã‚’ä½œæˆ
                    </a>
                    <button type="button" 
                            class="btn btn-light btn-large" 
                            onclick="duplicateCategory(@Model.Id)">
                        <span class="btn-icon">ğŸ“‹</span>
                        è¤‡è£½
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- è©³ç´°æƒ…å ±ã‚¿ãƒ– -->
    <div class="category-details-info">
        <div class="details-tabs">
            <div class="tab-navigation">
                <button class="tab-button active" onclick="showTab('products')" data-tab="products">
                    é–¢é€£å•†å“ (@Model.ProductCount)
                </button>
                @if (Model.ChildCategories?.Any() == true)
                {
                    <button class="tab-button" onclick="showTab('children')" data-tab="children">
                        å­ã‚«ãƒ†ã‚´ãƒª (@Model.ChildCategories.Count())
                    </button>
                }
                <button class="tab-button" onclick="showTab('hierarchy')" data-tab="hierarchy">
                    éšå±¤æƒ…å ±
                </button>
                <button class="tab-button" onclick="showTab('metadata')" data-tab="metadata">
                    ç®¡ç†æƒ…å ±
                </button>
            </div>
            
            <!-- é–¢é€£å•†å“ã‚¿ãƒ– -->
            <div id="productsTab" class="tab-content active">
                <div class="products-container">
                    @if (Model.Products?.Any() == true)
                    {
                        <div class="products-grid">
                            @foreach (var product in Model.Products)
                            {
                                <div class="product-card">
                                    <div class="product-image">
                                        @if (product.MainImagePath != null)
                                        {
                                            <img src="@product.MainImagePath" alt="@product.Name" class="product-thumbnail" />
                                        }
                                        else
                                        {
                                            <img src="/images/no-image.png" alt="ç”»åƒãªã—" class="product-thumbnail no-image" />
                                        }
                                    </div>
                                    <div class="product-info">
                                        <h4 class="product-name">
                                            <a asp-action="Details" asp-controller="Products" asp-route-id="@product.Id">
                                                @product.Name
                                            </a>
                                        </h4>
                                        <div class="product-price">Â¥@product.Price.ToString("N0")</div>
                                        @if (!string.IsNullOrEmpty(product.Description))
                                        {
                                            <div class="product-description">
                                                @(product.Description.Length > 60 ? product.Description.Substring(0, 60) + "..." : product.Description)
                                            </div>
                                        }
                                        <div class="product-status">
                                            @switch (product.Status)
                                            {
                                                case Web.Essentials.Domain.Entities.ProductStatus.PreSale:
                                                    <span class="status-badge status-pending">è²©å£²é–‹å§‹å‰</span>
                                                    break;
                                                case Web.Essentials.Domain.Entities.ProductStatus.OnSale:
                                                    <span class="status-badge status-active">è²©å£²ä¸­</span>
                                                    break;
                                                case Web.Essentials.Domain.Entities.ProductStatus.Discontinued:
                                                    <span class="status-badge status-discontinued">å–æ‰±çµ‚äº†</span>
                                                    break;
                                            }
                                        </div>
                                    </div>
                                    <div class="product-actions">
                                        <a asp-action="Details" asp-controller="Products" asp-route-id="@product.Id" 
                                           class="btn btn-info btn-sm">è©³ç´°</a>
                                        <a asp-action="Edit" asp-controller="Products" asp-route-id="@product.Id" 
                                           class="btn btn-warning btn-sm">ç·¨é›†</a>
                                    </div>
                                </div>
                            }
                        </div>
                        
                        <!-- å•†å“ä¸€è¦§ã¸ã®ãƒªãƒ³ã‚¯ -->
                        <div class="view-all-products">
                            <a asp-action="Index" asp-controller="Products" asp-route-categoryId="@Model.Id" 
                               class="btn btn-outline">
                                ã“ã®ã‚«ãƒ†ã‚´ãƒªã®å•†å“ã‚’ã™ã¹ã¦è¡¨ç¤º
                            </a>
                        </div>
                    }
                    else
                    {
                        <div class="no-products-message">
                            <div class="no-data-icon">ğŸ“¦</div>
                            <h3>ã“ã®ã‚«ãƒ†ã‚´ãƒªã«ã¯å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</h3>
                            <p>æ–°ã—ã„å•†å“ã‚’ç™»éŒ²ã™ã‚‹ã‹ã€æ—¢å­˜ã®å•†å“ã‚’ã“ã®ã‚«ãƒ†ã‚´ãƒªã«é–¢é€£ä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
                            <div class="action-buttons">
                                <a asp-action="Create" asp-controller="Products" asp-route-categoryId="@Model.Id" 
                                   class="btn btn-primary">
                                    æ–°ã—ã„å•†å“ã‚’ç™»éŒ²
                                </a>
                                <a asp-action="Index" asp-controller="Products" 
                                   class="btn btn-outline">
                                    æ—¢å­˜å•†å“ã‚’é–¢é€£ä»˜ã‘
                                </a>
                            </div>
                        </div>
                    }
                </div>
            </div>
            
            <!-- å­ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ– -->
            @if (Model.ChildCategories?.Any() == true)
            {
                <div id="childrenTab" class="tab-content">
                    <div class="children-container">
                        <div class="children-grid">
                            @foreach (var childCategory in Model.ChildCategories.OrderBy(c => c.SortOrder))
                            {
                                <div class="child-category-card">
                                    <div class="child-category-header">
                                        <h4 class="child-category-name">
                                            <a asp-action="Details" asp-controller="Categories" asp-route-id="@childCategory.Id">
                                                @childCategory.Name
                                            </a>
                                        </h4>
                                        <span class="level-badge level-@childCategory.Level">L@childCategory.Level</span>
                                    </div>
                                    @if (!string.IsNullOrEmpty(childCategory.Description))
                                    {
                                        <div class="child-category-description">
                                            @(childCategory.Description.Length > 80 ? childCategory.Description.Substring(0, 80) + "..." : childCategory.Description)
                                        </div>
                                    }
                                    <div class="child-category-stats">
                                        <span class="stat-item">
                                            <span class="stat-icon">ğŸ“¦</span>
                                            @childCategory.ProductCount å•†å“
                                        </span>
                                        @if (childCategory.HasChildren)
                                        {
                                            <span class="stat-item">
                                                <span class="stat-icon">ğŸ·ï¸</span>
                                                å­ã‚«ãƒ†ã‚´ãƒªã‚ã‚Š
                                            </span>
                                        }
                                    </div>
                                    <div class="child-category-actions">
                                        <a asp-action="Details" asp-controller="Categories" asp-route-id="@childCategory.Id" 
                                           class="btn btn-info btn-sm">è©³ç´°</a>
                                        <a asp-action="Edit" asp-controller="Categories" asp-route-id="@childCategory.Id" 
                                           class="btn btn-warning btn-sm">ç·¨é›†</a>
                                    </div>
                                </div>
                            }
                        </div>
                        
                        <!-- å­ã‚«ãƒ†ã‚´ãƒªè¿½åŠ  -->
                        <div class="add-child-category">
                            <a asp-action="Create" asp-controller="Categories" asp-route-parentId="@Model.Id" 
                               class="btn btn-primary">
                                <span class="btn-icon">â•</span>
                                æ–°ã—ã„å­ã‚«ãƒ†ã‚´ãƒªã‚’ä½œæˆ
                            </a>
                        </div>
                    </div>
                </div>
            }
            
            <!-- éšå±¤æƒ…å ±ã‚¿ãƒ– -->
            <div id="hierarchyTab" class="tab-content">
                <div class="hierarchy-container">
                    <!-- è¦ªã‚«ãƒ†ã‚´ãƒªæƒ…å ± -->
                    @if (Model.ParentCategory != null)
                    {
                        <div class="hierarchy-section">
                            <h3 class="hierarchy-title">è¦ªã‚«ãƒ†ã‚´ãƒª</h3>
                            <div class="parent-category-card">
                                <div class="parent-category-info">
                                    <h4 class="parent-category-name">
                                        <a asp-action="Details" asp-controller="Categories" asp-route-id="@Model.ParentCategory.Id">
                                            @Model.ParentCategory.Name
                                        </a>
                                    </h4>
                                    <span class="level-badge level-@Model.ParentCategory.Level">L@Model.ParentCategory.Level</span>
                                </div>
                                @if (!string.IsNullOrEmpty(Model.ParentCategory.Description))
                                {
                                    <div class="parent-category-description">
                                        @Model.ParentCategory.Description
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    
                    <!-- éšå±¤æ§‹é€ è¡¨ç¤º -->
                    <div class="hierarchy-section">
                        <h3 class="hierarchy-title">éšå±¤æ§‹é€ </h3>
                        <div class="hierarchy-tree">
                            <partial name="_CategoryHierarchy" model="new List<dynamic> { Model }" />
                        </div>
                    </div>
                    
                    <!-- åŒéšå±¤ã‚«ãƒ†ã‚´ãƒª -->
                    @if (Model.SiblingCategories?.Any() == true)
                    {
                        <div class="hierarchy-section">
                            <h3 class="hierarchy-title">åŒéšå±¤ã®ã‚«ãƒ†ã‚´ãƒª</h3>
                            <div class="siblings-list">
                                @foreach (var sibling in Model.SiblingCategories)
                                {
                                    <div class="sibling-item @(sibling.Id == Model.Id ? "current" : "")">
                                        @if (sibling.Id == Model.Id)
                                        {
                                            <span class="sibling-name current">@sibling.Nameï¼ˆç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒªï¼‰</span>
                                        }
                                        else
                                        {
                                            <a asp-action="Details" asp-controller="Categories" asp-route-id="@sibling.Id" 
                                               class="sibling-link">
                                                @sibling.Name
                                            </a>
                                        }
                                        <span class="sibling-stats">(@sibling.ProductCount å•†å“)</span>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
            
            <!-- ç®¡ç†æƒ…å ±ã‚¿ãƒ– -->
            <div id="metadataTab" class="tab-content">
                <div class="metadata-grid">
                    <div class="metadata-item">
                        <label class="metadata-label">ã‚«ãƒ†ã‚´ãƒªID</label>
                        <span class="metadata-value">@Model.Id</span>
                    </div>
                    
                    <div class="metadata-item">
                        <label class="metadata-label">éšå±¤ãƒ¬ãƒ™ãƒ«</label>
                        <span class="metadata-value">@Model.Level</span>
                    </div>
                    
                    <div class="metadata-item">
                        <label class="metadata-label">è¡¨ç¤ºé †åº</label>
                        <span class="metadata-value">@Model.SortOrder</span>
                    </div>
                    
                    <div class="metadata-item">
                        <label class="metadata-label">ä½œæˆæ—¥æ™‚</label>
                        <span class="metadata-value">
                            <time datetime="@Model.CreatedAt.ToString("yyyy-MM-ddTHH:mm:ss")">
                                @Model.CreatedAt.ToString("yyyyå¹´MMæœˆddæ—¥ HH:mm:ss")
                            </time>
                        </span>
                    </div>
                    
                    <div class="metadata-item">
                        <label class="metadata-label">æœ€çµ‚æ›´æ–°æ—¥æ™‚</label>
                        <span class="metadata-value">
                            <time datetime="@Model.UpdatedAt.ToString("yyyy-MM-ddTHH:mm:ss")">
                                @Model.UpdatedAt.ToString("yyyyå¹´MMæœˆddæ—¥ HH:mm:ss")
                            </time>
                        </span>
                    </div>
                    
                    @if (Model.CreatedAt != Model.UpdatedAt)
                    {
                        <div class="metadata-item">
                            <label class="metadata-label">æœ€çµ‚æ›´æ–°ã‹ã‚‰ã®çµŒéæ™‚é–“</label>
                            <span class="metadata-value">
                                @{
                                    var timeDiff = DateTime.Now - Model.UpdatedAt;
                                    var timeDiffText = timeDiff.Days > 0 ? $"{timeDiff.Days}æ—¥å‰" :
                                                      timeDiff.Hours > 0 ? $"{timeDiff.Hours}æ™‚é–“å‰" :
                                                      timeDiff.Minutes > 0 ? $"{timeDiff.Minutes}åˆ†å‰" : "1åˆ†ä»¥å†…";
                                }
                                @timeDiffText
                            </span>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/category-details.js" asp-append-version="true" defer></script>
}