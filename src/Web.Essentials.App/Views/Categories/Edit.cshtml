@model Web.Essentials.App.ViewModels.CategoryEditViewModel
@{
    ViewData["Title"] = $"ã‚«ãƒ†ã‚´ãƒªç·¨é›† - {Model.Name}";
}

<!-- ã‚«ãƒ†ã‚´ãƒªç·¨é›†ç”»é¢ -->
<div class="page-header">
    <div class="page-title-section">
        <h1 class="page-title">ã‚«ãƒ†ã‚´ãƒªç·¨é›†</h1>
        <p class="page-description">ã‚«ãƒ†ã‚´ãƒªã€Œ@Model.Nameã€ã®æƒ…å ±ã‚’ç·¨é›†ã—ã¾ã™ã€‚</p>
    </div>
    <div class="page-actions">
        <a href="@Url.Action("Details", "Categories", new { id = Model.Id })" class="btn btn-info">
            <span class="btn-icon">ğŸ‘</span>
            è©³ç´°è¡¨ç¤º
        </a>
        <a href="@Url.Action("Index", "Categories")" class="btn btn-secondary">
            <span class="btn-icon">â†</span>
            ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã«æˆ»ã‚‹
        </a>
    </div>
</div>

<!-- ãƒ‘ãƒ³ããšãƒŠãƒ“ -->
<nav class="breadcrumb-nav" aria-label="ãƒ‘ãƒ³ããšãƒŠãƒ“">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="@Url.Action("Index", "Home")">ãƒ›ãƒ¼ãƒ </a>
        </li>
        <li class="breadcrumb-item">
            <a href="@Url.Action("Index", "Categories")">ã‚«ãƒ†ã‚´ãƒªä¸€è¦§</a>
        </li>
        <li class="breadcrumb-item">
            <a href="@Url.Action("Details", "Categories", new { id = Model.Id })">@Model.Name</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            ç·¨é›†
        </li>
    </ol>
</nav>

<!-- ã‚«ãƒ†ã‚´ãƒªç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
<div class="form-container">
    <form asp-action="Edit" 
          method="post" 
          id="categoryEditForm" 
          class="category-form"
          novalidate>
        
        @Html.AntiForgeryToken()
        @Html.HiddenFor(model => model.Id)
        
        <!-- ç·¨é›†å±¥æ­´æƒ…å ± -->
        <div class="form-section info-section">
            <h3 class="section-title">ã‚«ãƒ†ã‚´ãƒªæƒ…å ±</h3>
            <div class="info-grid">
                <div class="info-item">
                    <label class="info-label">ã‚«ãƒ†ã‚´ãƒªID</label>
                    <span class="info-value">@Model.Id</span>
                </div>
                <div class="info-item">
                    <label class="info-label">ç¾åœ¨ã®éšå±¤ãƒ¬ãƒ™ãƒ«</label>
                    <span class="info-value">
                        <span class="level-badge level-@Model.Level">ãƒ¬ãƒ™ãƒ« @Model.Level</span>
                    </span>
                </div>
                <div class="info-item">
                    <label class="info-label">ä½œæˆæ—¥æ™‚</label>
                    <span class="info-value">@Model.CreatedAt.ToString("yyyy/MM/dd HH:mm:ss")</span>
                </div>
                <div class="info-item">
                    <label class="info-label">æœ€çµ‚æ›´æ–°æ—¥æ™‚</label>
                    <span class="info-value">@Model.UpdatedAt.ToString("yyyy/MM/dd HH:mm:ss")</span>
                </div>
                @if (Model.ProductCount > 0)
                {
                    <div class="info-item">
                        <label class="info-label">é–¢é€£å•†å“æ•°</label>
                        <span class="info-value">@Model.ProductCount å€‹</span>
                    </div>
                }
                @if (Model.ChildCategories?.Any() == true)
                {
                    <div class="info-item">
                        <label class="info-label">å­ã‚«ãƒ†ã‚´ãƒªæ•°</label>
                        <span class="info-value">@Model.ChildCategories.Count å€‹</span>
                    </div>
                }
            </div>
        </div>
        
        <!-- éšå±¤è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="form-section">
            <h3 class="section-title">éšå±¤è¨­å®š</h3>
            
            @if (Model.ChildCategories?.Any() == true)
            {
                <div class="warning-message">
                    <div class="warning-icon">âš ï¸</div>
                    <div class="warning-content">
                        <strong>éšå±¤å¤‰æ›´ã®åˆ¶é™</strong>
                        <p>ã“ã®ã‚«ãƒ†ã‚´ãƒªã«ã¯å­ã‚«ãƒ†ã‚´ãƒªãŒå­˜åœ¨ã™ã‚‹ãŸã‚ã€è¦ªã‚«ãƒ†ã‚´ãƒªã®å¤‰æ›´ã¯ã§ãã¾ã›ã‚“ã€‚å­ã‚«ãƒ†ã‚´ãƒªã‚’å…ˆã«ç§»å‹•ã¾ãŸã¯å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                </div>
            }
            
            <div class="form-group">
                <label asp-for="ParentCategoryId" class="form-label">è¦ªã‚«ãƒ†ã‚´ãƒª</label>
                <select asp-for="ParentCategoryId" 
                        class="form-select" 
                        id="parentCategorySelect"
                        onchange="updateCategoryLevel()"
                        @(Model.ChildCategories?.Any() == true ? "disabled" : "")>
                    <option value="">ãƒ«ãƒ¼ãƒˆã‚«ãƒ†ã‚´ãƒªã¨ã—ã¦è¨­å®š</option>
                    @if (Model.ParentCategories?.Any() == true)
                    {
                        @foreach (var parentCategory in Model.ParentCategories)
                        {
                            <option value="@parentCategory.Id" 
                                    data-level="@parentCategory.Level"
                                    @(Model.ParentCategoryId == parentCategory.Id ? "selected" : "")>
                                @parentCategory.FullPath
                            </option>
                        }
                    }
                </select>
                <span asp-validation-for="ParentCategoryId" class="validation-error"></span>
                @if (Model.ChildCategories?.Any() == true)
                {
                    <div class="field-help">
                        <small class="text-warning">å­ã‚«ãƒ†ã‚´ãƒªãŒå­˜åœ¨ã™ã‚‹ãŸã‚ã€è¦ªã‚«ãƒ†ã‚´ãƒªã®å¤‰æ›´ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚</small>
                    </div>
                }
                else
                {
                    <div class="field-help">
                        <small>è¦ªã‚«ãƒ†ã‚´ãƒªã‚’å¤‰æ›´ã™ã‚‹ã¨ã€éšå±¤æ§‹é€ ãŒå¤‰æ›´ã•ã‚Œã¾ã™ã€‚</small>
                    </div>
                }
            </div>
            
            <!-- éšå±¤ãƒ¬ãƒ™ãƒ«è¡¨ç¤º -->
            <div class="hierarchy-preview">
                <div class="hierarchy-info">
                    <label class="form-label">æ›´æ–°å¾Œã®éšå±¤ãƒ¬ãƒ™ãƒ«</label>
                    <div id="hierarchyLevelDisplay" class="level-display">
                        <span id="levelBadge" class="level-badge level-@Model.Level">ãƒ¬ãƒ™ãƒ« @Model.Level</span>
                        <span id="levelDescription" class="level-description"></span>
                    </div>
                </div>
                <div id="hierarchyPathPreview" class="hierarchy-path-preview">
                    <label class="form-label">éšå±¤ãƒ‘ã‚¹</label>
                    <div id="pathPreview" class="path-preview">@Model.FullPath</div>
                </div>
            </div>
            
            <!-- å­ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ï¼ˆç·¨é›†åˆ¶é™ã®èª¬æ˜ç”¨ï¼‰ -->
            @if (Model.ChildCategories?.Any() == true)
            {
                <div class="child-categories-info">
                    <h4 class="subsection-title">å­ã‚«ãƒ†ã‚´ãƒªä¸€è¦§</h4>
                    <div class="child-categories-list">
                        @foreach (var child in Model.ChildCategories)
                        {
                            <div class="child-category-item">
                                <span class="child-category-name">@child.Name</span>
                                <span class="child-category-path">(@child.FullPath)</span>
                                <a href="@Url.Action("Edit", "Categories", new { id = child.Id })" 
                                   class="btn btn-sm btn-outline">ç·¨é›†</a>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
        
        <!-- ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚©ãƒ¼ãƒ ï¼ˆéƒ¨åˆ†ãƒ“ãƒ¥ãƒ¼ï¼‰ -->
        @Html.Partial("_CategoryForm", Model)
        
        <!-- å¤‰æ›´å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="form-section">
            <h3 class="section-title">å¤‰æ›´å±¥æ­´</h3>
            <div class="change-history">
                <div id="changeHistory" class="history-list">
                    <!-- å¤‰æ›´å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    <p class="no-changes">å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            </div>
        </div>
        
        <!-- ãƒ•ã‚©ãƒ¼ãƒ æ“ä½œãƒœã‚¿ãƒ³ -->
        <div class="form-actions">
            <div class="action-buttons">
                <button type="submit" class="btn btn-primary btn-large" id="saveButton">
                    <span class="btn-icon">ğŸ’¾</span>
                    å¤‰æ›´ã‚’ä¿å­˜
                </button>
                <button type="button" class="btn btn-warning btn-large" onclick="showSaveAsNewModal()">
                    <span class="btn-icon">ğŸ“‹</span>
                    åˆ¥ã‚«ãƒ†ã‚´ãƒªã¨ã—ã¦ä¿å­˜
                </button>
                <button type="button" class="btn btn-outline btn-large" onclick="previewCategory()">
                    <span class="btn-icon">ğŸ‘</span>
                    ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                </button>
                <button type="button" class="btn btn-light btn-large" onclick="resetForm()">
                    <span class="btn-icon">â†»</span>
                    å¤‰æ›´ã‚’ç ´æ£„
                </button>
            </div>
            
            <!-- ä¿å­˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
            <div class="save-options">
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="validateBeforeSave" class="checkbox-input" checked>
                        <span class="checkbox-custom"></span>
                        ä¿å­˜å‰ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹
                    </label>
                </div>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="keepEditingAfterSave" class="checkbox-input">
                        <span class="checkbox-custom"></span>
                        ä¿å­˜å¾Œã‚‚ç·¨é›†ç”»é¢ã«ç•™ã¾ã‚‹
                    </label>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- åˆ¥ã‚«ãƒ†ã‚´ãƒªã¨ã—ã¦ä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="saveAsNewModal" class="modal-overlay" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">åˆ¥ã‚«ãƒ†ã‚´ãƒªã¨ã—ã¦ä¿å­˜</h3>
                <button type="button" class="modal-close" onclick="closeSaveAsNewModal()">
                    <span>Ã—</span>
                </button>
            </div>
            <div class="modal-body">
                <p>ç¾åœ¨ã®ç·¨é›†å†…å®¹ã‚’æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ</p>
                <div class="form-group">
                    <label for="newCategoryName" class="form-label">æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªå</label>
                    <input type="text" 
                           id="newCategoryName" 
                           class="form-input" 
                           value="@Model.Name ã®ã‚³ãƒ”ãƒ¼"
                           maxlength="50" />
                </div>
                <div class="form-group">
                    <label for="newParentCategory" class="form-label">è¦ªã‚«ãƒ†ã‚´ãƒª</label>
                    <select id="newParentCategory" class="form-select">
                        <option value="">ãƒ«ãƒ¼ãƒˆã‚«ãƒ†ã‚´ãƒªã¨ã—ã¦ä½œæˆ</option>
                        @if (Model.ParentCategories?.Any() == true)
                        {
                            @foreach (var parentCategory in Model.ParentCategories)
                            {
                                <option value="@parentCategory.Id">@parentCategory.FullPath</option>
                            }
                        }
                    </select>
                </div>
                <div class="warning-message">
                    <p><strong>æ³¨æ„:</strong> å…ƒã®ã‚«ãƒ†ã‚´ãƒªã¯å¤‰æ›´ã•ã‚Œã¾ã›ã‚“ã€‚æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã¨ã—ã¦åˆ¥é€”ä½œæˆã•ã‚Œã¾ã™ã€‚</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeSaveAsNewModal()">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="button" class="btn btn-primary" onclick="saveAsNewCategory()">
                    æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã¨ã—ã¦ä¿å­˜
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="categoryPreviewModal" class="modal-overlay preview-modal" style="display: none;">
    <div class="modal-dialog modal-large">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ã‚«ãƒ†ã‚´ãƒªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <button type="button" class="modal-close" onclick="closePreviewModal()">
                    <span>Ã—</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="categoryPreviewContent" class="preview-content">
                    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closePreviewModal()">
                    é–‰ã˜ã‚‹
                </button>
                <button type="button" class="btn btn-primary" onclick="submitFromPreview()">
                    ã“ã®ã¾ã¾ä¿å­˜ã™ã‚‹
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // åˆæœŸå€¤ã‚’ä¿å­˜ï¼ˆå¤‰æ›´æ¤œçŸ¥ç”¨ï¼‰
        let originalFormData = {};
        
        // ãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeCategoryEditForm();
        });
        
        // ã‚«ãƒ†ã‚´ãƒªç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®åˆæœŸåŒ–
        function initializeCategoryEditForm() {
            // åˆæœŸå€¤ã‚’ä¿å­˜
            originalFormData = collectFormData();
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®š
            setupFormValidation();
            
            // å¤‰æ›´æ¤œçŸ¥ã®è¨­å®š
            setupChangeDetection();
            
            // éšå±¤ãƒ¬ãƒ™ãƒ«è¡¨ç¤ºã®åˆæœŸåŒ–
            updateCategoryLevel();
            
            // ãƒšãƒ¼ã‚¸é›¢è„±è­¦å‘Šã®è¨­å®š
            setupUnloadWarning();
        }
        
        // éšå±¤ãƒ¬ãƒ™ãƒ«æ›´æ–°
        function updateCategoryLevel() {
            const parentSelect = document.getElementById('parentCategorySelect');
            const selectedOption = parentSelect.options[parentSelect.selectedIndex];
            
            const levelBadge = document.getElementById('levelBadge');
            const levelDescription = document.getElementById('levelDescription');
            const pathPreview = document.getElementById('pathPreview');
            
            if (selectedOption.value === '') {
                // ãƒ«ãƒ¼ãƒˆã‚«ãƒ†ã‚´ãƒª
                levelBadge.textContent = 'ãƒ¬ãƒ™ãƒ« 0';
                levelBadge.className = 'level-badge level-0';
                levelDescription.textContent = 'ï¼ˆãƒ«ãƒ¼ãƒˆã‚«ãƒ†ã‚´ãƒªï¼‰';
                
                const currentName = document.querySelector('input[name="Name"]').value || '@Model.Name';
                pathPreview.textContent = currentName;
            } else {
                // å­ã‚«ãƒ†ã‚´ãƒª
                const parentLevel = parseInt(selectedOption.dataset.level) || 0;
                const newLevel = parentLevel + 1;
                
                levelBadge.textContent = `ãƒ¬ãƒ™ãƒ« ${newLevel}`;
                levelBadge.className = `level-badge level-${newLevel}`;
                levelDescription.textContent = `ï¼ˆ${newLevel} éšå±¤ç›®ï¼‰`;
                
                // éšå±¤ãƒ‘ã‚¹æ›´æ–°
                const parentPath = selectedOption.textContent;
                const currentName = document.querySelector('input[name="Name"]').value || '@Model.Name';
                pathPreview.textContent = `${parentPath} > ${currentName}`;
            }
        }
        
        // å¤‰æ›´æ¤œçŸ¥ã®è¨­å®š
        function setupChangeDetection() {
            const form = document.getElementById('categoryEditForm');
            const inputs = form.querySelectorAll('input, select, textarea');
            
            inputs.forEach(input => {
                input.addEventListener('input', detectChanges);
                input.addEventListener('change', detectChanges);
            });
        }
        
        // å¤‰æ›´æ¤œçŸ¥
        function detectChanges() {
            const currentData = collectFormData();
            const changes = compareFormData(originalFormData, currentData);
            updateChangeHistory(changes);
            
            // éšå±¤ãƒ‘ã‚¹æ›´æ–°
            if (document.querySelector('input[name="Name"]')) {
                updateCategoryLevel();
            }
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿æ¯”è¼ƒ
        function compareFormData(original, current) {
            const changes = [];
            
            for (let key in current) {
                if (original[key] !== current[key]) {
                    changes.push({
                        field: key,
                        from: original[key],
                        to: current[key],
                        timestamp: new Date()
                    });
                }
            }
            
            return changes;
        }
        
        // å¤‰æ›´å±¥æ­´æ›´æ–°
        function updateChangeHistory(changes) {
            const historyContainer = document.getElementById('changeHistory');
            
            if (changes.length === 0) {
                historyContainer.innerHTML = '<p class="no-changes">å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            const historyHtml = changes.map(change => `
                <div class="history-item">
                    <div class="history-field">${getFieldDisplayName(change.field)}</div>
                    <div class="history-change">
                        <span class="change-from">${change.from || '(ç©º)'}</span>
                        <span class="change-arrow">â†’</span>
                        <span class="change-to">${change.to || '(ç©º)'}</span>
                    </div>
                    <div class="history-time">${change.timestamp.toLocaleTimeString()}</div>
                </div>
            `).join('');
            
            historyContainer.innerHTML = historyHtml;
        }
        
        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¡¨ç¤ºåå–å¾—
        function getFieldDisplayName(fieldName) {
            const fieldNames = {
                'Name': 'ã‚«ãƒ†ã‚´ãƒªå',
                'Description': 'ã‚«ãƒ†ã‚´ãƒªèª¬æ˜',
                'ParentCategoryId': 'è¦ªã‚«ãƒ†ã‚´ãƒª'
            };
            
            return fieldNames[fieldName] || fieldName;
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        document.getElementById('categoryEditForm').addEventListener('submit', function(event) {
            const validateBeforeSave = document.getElementById('validateBeforeSave').checked;
            
            if (validateBeforeSave) {
                event.preventDefault();
                
                if (validateCategoryForm()) {
                    submitCategoryForm();
                }
            }
        });
        
        // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚©ãƒ¼ãƒ ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function validateCategoryForm() {
            let isValid = true;
            const errors = [];
            
            // ã‚«ãƒ†ã‚´ãƒªåã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const nameInput = document.querySelector('input[name="Name"]');
            if (!nameInput.value.trim()) {
                errors.push('ã‚«ãƒ†ã‚´ãƒªåã¯å¿…é ˆã§ã™');
                highlightFieldError(nameInput);
                isValid = false;
            } else if (nameInput.value.length > 50) {
                errors.push('ã‚«ãƒ†ã‚´ãƒªåã¯50æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                highlightFieldError(nameInput);
                isValid = false;
            }
            
            // èª¬æ˜ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const descriptionInput = document.querySelector('textarea[name="Description"]');
            if (descriptionInput.value && descriptionInput.value.length > 500) {
                errors.push('ã‚«ãƒ†ã‚´ãƒªèª¬æ˜ã¯500æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                highlightFieldError(descriptionInput);
                isValid = false;
            }
            
            // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
            if (!isValid) {
                showValidationErrors(errors);
            } else {
                hideValidationErrors();
            }
            
            return isValid;
        }
        
        // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        async function submitCategoryForm() {
            try {
                showLoadingModal('ã‚«ãƒ†ã‚´ãƒªã‚’æ›´æ–°ã—ã¦ã„ã¾ã™...');
                
                const formData = new FormData(document.getElementById('categoryEditForm'));
                
                const response = await fetch('/Categories/Edit/@Model.Id', {
                    method: 'POST',
                    body: formData
                });
                
                hideLoadingModal();
                
                if (response.ok) {
                    const keepEditing = document.getElementById('keepEditingAfterSave').checked;
                    
                    showSuccess('ã‚«ãƒ†ã‚´ãƒªãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸ');
                    
                    if (keepEditing) {
                        // åˆæœŸå€¤ã‚’æ›´æ–°
                        originalFormData = collectFormData();
                        updateChangeHistory([]);
                    } else {
                        // ã‚«ãƒ†ã‚´ãƒªè©³ç´°ã«æˆ»ã‚‹
                        setTimeout(() => {
                            window.location.href = '/Categories/Details/@Model.Id';
                        }, 1500);
                    }
                } else {
                    const errorText = await response.text();
                    showError('ã‚«ãƒ†ã‚´ãƒªã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + errorText);
                }
            } catch (error) {
                hideLoadingModal();
                console.error('ã‚«ãƒ†ã‚´ãƒªæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                showError('ã‚«ãƒ†ã‚´ãƒªæ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
        
        // åˆ¥ã‚«ãƒ†ã‚´ãƒªã¨ã—ã¦ä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showSaveAsNewModal() {
            document.getElementById('saveAsNewModal').style.display = 'block';
        }
        
        // åˆ¥ã‚«ãƒ†ã‚´ãƒªã¨ã—ã¦ä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeSaveAsNewModal() {
            document.getElementById('saveAsNewModal').style.display = 'none';
        }
        
        // åˆ¥ã‚«ãƒ†ã‚´ãƒªã¨ã—ã¦ä¿å­˜å®Ÿè¡Œ
        async function saveAsNewCategory() {
            try {
                const newCategoryName = document.getElementById('newCategoryName').value;
                const newParentCategory = document.getElementById('newParentCategory').value;
                
                if (!newCategoryName.trim()) {
                    showError('æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                
                showLoadingModal('æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã¨ã—ã¦ä¿å­˜ã—ã¦ã„ã¾ã™...');
                
                const formData = new FormData(document.getElementById('categoryEditForm'));
                formData.set('Name', newCategoryName); // ã‚«ãƒ†ã‚´ãƒªåã‚’æ›´æ–°
                formData.set('ParentCategoryId', newParentCategory); // è¦ªã‚«ãƒ†ã‚´ãƒªã‚’æ›´æ–°
                formData.delete('Id'); // IDã‚’å‰Šé™¤ï¼ˆæ–°è¦ä½œæˆï¼‰
                
                const response = await fetch('/Categories/Create', {
                    method: 'POST',
                    body: formData
                });
                
                hideLoadingModal();
                
                if (response.ok) {
                    showSuccess(`æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã€Œ${newCategoryName}ã€ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã—ãŸ`);
                    closeSaveAsNewModal();
                    
                    // ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã«æˆ»ã‚‹
                    setTimeout(() => {
                        window.location.href = '/Categories';
                    }, 1500);
                } else {
                    const errorText = await response.text();
                    showError('æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + errorText);
                }
            } catch (error) {
                hideLoadingModal();
                console.error('æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showError('æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        function resetForm() {
            if (confirm('å¤‰æ›´å†…å®¹ã‚’ç ´æ£„ã—ã¦å…ƒã®çŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
                // å…ƒã®å€¤ã«æˆ»ã™
                for (let key in originalFormData) {
                    const input = document.querySelector(`[name="${key}"]`);
                    if (input) {
                        input.value = originalFormData[key];
                    }
                }
                
                updateCategoryLevel();
                updateChangeHistory([]);
                hideValidationErrors();
            }
        }
        
        // ãƒšãƒ¼ã‚¸é›¢è„±è­¦å‘Šã®è¨­å®š
        function setupUnloadWarning() {
            window.addEventListener('beforeunload', function(event) {
                const currentData = collectFormData();
                const changes = compareFormData(originalFormData, currentData);
                
                if (changes.length > 0) {
                    event.preventDefault();
                    event.returnValue = 'å¤‰æ›´ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã¾ã™ã‹ï¼Ÿ';
                }
            });
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿åé›†
        function collectFormData() {
            const form = document.getElementById('categoryEditForm');
            const formData = new FormData(form);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            return data;
        }
    </script>
}